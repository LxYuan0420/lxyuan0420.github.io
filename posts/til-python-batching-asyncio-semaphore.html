<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lx | TIL: Asyncio for API Requests - Batching vs. Semaphore</title>
  <meta name="description" content="This article describes the difference between manual batching vs Semaphore.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="TIL: Asyncio for API Requests - Batching vs. Semaphore">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://lxyuan0420.github.io/posts/til-python-batching-asyncio-semaphore">
  <meta property="og:description" content="This article describes the difference between manual batching vs Semaphore.">
  <meta property="og:site_name" content="Lx">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://lxyuan0420.github.io/posts/til-python-batching-asyncio-semaphore">
  <meta name="twitter:title" content="TIL: Asyncio for API Requests - Batching vs. Semaphore">
  <meta name="twitter:description" content="This article describes the difference between manual batching vs Semaphore.">

  
    <meta property="og:image" content="https://lxyuan0420.github.io/assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
    <meta name="twitter:image" content="https://lxyuan0420.github.io/assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
  

  <link href="https://lxyuan0420.github.io/feed.xml" type="application/rss+xml" rel="alternate" title="Lx Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-light-a98c41efc5ed9fcc06ac664c9e2f7a9b3c3b2e0a52357d221fe382f6f4abc8fc.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-light-87d1f2a3a19b1500e5c1626a0492025ca5f7f97d24540dc5900288e92112925a.png">
      <link rel="stylesheet" type="text/css" href="/assets/light-bb1553a18d0f1ccfe1aabc010584c49b4277a88503216b78906ba719e30019c1.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="Lx">Lx</a>
  <ul class="header-links">
    
    
      <li>
        <a href="https://twitter.com/lxyuan" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/LxYuan0420" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/likxunyuan" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:lxyuan0420@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>TIL: Asyncio for API Requests - Batching vs. Semaphore</h1>
            <p>This article describes the difference between manual batching vs Semaphore.</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    January 19, 2024
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      5 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>In the world of API requests, like those to Wikipedia, we often face the
challenge of rate limits. To navigate this efficiently with Python’s asyncio, I
dived into two strategies: <strong>Batching</strong> and <strong>Semaphore</strong>. Batching breaks down
requests into manageable groups, processing them sequentially like a relay
race. On the flip side, Semaphore manages how many requests run concurrently,
akin to a bouncer controlling a nightclub’s entry.</p>

<p>During my tests on a Wikipedia public API to retrieve data for 100 entities, I uncovered some intriguing insights. With batching, I sent 10 requests at a time in systematic bursts, ensuring a steady and safer approach. Semaphore, though set to 10 concurrent requests, initially stumbled upon rate limits, fetching fewer results. This mimicked real-world API interactions, like Wikipedia’s defense mechanisms against potential abuse.</p>

<p>The key turning point was introducing a delay in the Semaphore method. This small tweak made a significant difference, balancing speed and adherence to API rate limits. It became clear that a more measured approach could outshine sheer speed, particularly when external constraints like API limitations come into play.</p>

<h3 id="key-lessons-learned">Key Lessons Learned:</h3>

<p><strong>The Reality of Rate Limiting</strong>: APIs have built-in measures to thwart abuse. Bombarding an API too rapidly can result in blocks. It’s crucial to verify the actual results, ensuring they are valid and not empty (None).</p>

<p><strong>The Safety of Batching</strong>: Batching naturally spaces out requests, effectively reducing the risk of hitting rate limits. While its simplicity might seem less ‘Pythonic’ to some, its straightforward nature (processing batch by batch) is often more reliable in avoiding rate limit triggers.</p>

<p><em>*The Nuance of Semaphores</em>k: Semaphores, while appearing more Pythonic, require careful calibration. Not all results are guaranteed to be complete. Adjusting the concurrency limits and strategically introducing delays can prevent triggering the API’s defensive measures.</p>

<h4 id="below-is-the-test-script">Below is the test script:</h4>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">aiohttp</span>


<span class="c1"># Async function to fetch data from Wikipedia API
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_wikipedia_page</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://en.wikipedia.org/w/rest.php/v1/search/page"</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"limit"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">"q"</span><span class="p">:</span> <span class="n">entity</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="c1"># Batching method
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_with_batching</span><span class="p">(</span>
    <span class="n">entities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">entities</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">fetch_wikipedia_page</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="n">results</span> <span class="o">+=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>


<span class="c1"># Semaphore method
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_with_semaphore</span><span class="p">(</span>
    <span class="n">entities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">max_concurrent_requests</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_requests</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fetch_with_semaphore_task</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_with_semaphore_task</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">fetch_wikipedia_page</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>



<span class="c1"># Test function to compare both methods
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">compare_methods</span><span class="p">(</span><span class="n">entities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="c1"># Testing batching method
</span>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">results_batching</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_with_batching</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Batching Method Time: </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> seconds"</span><span class="p">)</span>

    <span class="c1"># Testing semaphore method
</span>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">results_semaphore</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_with_semaphore</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">max_concurrent_requests</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Semaphore Method Time: </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> seconds"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results_batching</span><span class="p">,</span> <span class="n">results_semaphore</span>


<span class="c1"># List of entities for testing
</span><span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Python"</span><span class="p">,</span> <span class="s">"JavaScript"</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"DEBUG: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Run the comparison
</span><span class="n">batching_results</span><span class="p">,</span> <span class="n">semaphore_results</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">compare_methods</span><span class="p">(</span><span class="n">entities</span><span class="p">))</span>

<span class="n">non_none_batching_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batching_results</span> <span class="k">if</span> <span class="n">item</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"DEBUG: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">non_none_batching_results</span><span class="p">)</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">non_none_semaphore_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">semaphore_results</span> <span class="k">if</span> <span class="n">item</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"DEBUG: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">non_none_semaphore_results</span><span class="p">)</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="s">"""
&gt;&gt;&gt; DEBUG: len(entities) = 100
&gt;&gt;&gt; Batching Method Time: 3.6377 seconds
&gt;&gt;&gt; Semaphore Method Time: 2.4993 seconds
&gt;&gt;&gt; DEBUG: len(non_none_batching_results) = 100
&gt;&gt;&gt; DEBUG: len(non_none_semaphore_results) = 45
"""</span></code></pre></figure>


          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=TIL:+Asyncio+for+API+Requests+-+Batching+vs.+Semaphore%20-%20https://lxyuan0420.github.io/posts/til-python-batching-asyncio-semaphore%20by%20@lxyuan" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://lxyuan0420.github.io/posts/til-python-batching-asyncio-semaphore" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
        </article>
        <footer class="footer scrollappear">
  <p>
    Made with <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Download Chalk">Chalk</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  

<script src="/assets/vendor-3ee2c63bbac916f96cd7f90e83ab767f058ead1301444c9966f5156911c8be7f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
