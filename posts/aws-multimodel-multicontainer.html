<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lx | AWS Endpoint: Multi-model vs Multi-container</title>
  <meta name="description" content="This article briefly explains the difference between multi-model and multi-container AWS endpoint deployment">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="AWS Endpoint: Multi-model vs Multi-container">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://lxyuan0420.github.io/posts/aws-multimodel-multicontainer">
  <meta property="og:description" content="This article briefly explains the difference between multi-model and multi-container AWS endpoint deployment">
  <meta property="og:site_name" content="Lx">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://lxyuan0420.github.io/posts/aws-multimodel-multicontainer">
  <meta name="twitter:title" content="AWS Endpoint: Multi-model vs Multi-container">
  <meta name="twitter:description" content="This article briefly explains the difference between multi-model and multi-container AWS endpoint deployment">

  
    <meta property="og:image" content="https://lxyuan0420.github.io/assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
    <meta name="twitter:image" content="https://lxyuan0420.github.io/assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
  

  <link href="https://lxyuan0420.github.io/feed.xml" type="application/rss+xml" rel="alternate" title="Lx Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-light-a98c41efc5ed9fcc06ac664c9e2f7a9b3c3b2e0a52357d221fe382f6f4abc8fc.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-light-87d1f2a3a19b1500e5c1626a0492025ca5f7f97d24540dc5900288e92112925a.png">
      <link rel="stylesheet" type="text/css" href="/assets/light-bb1553a18d0f1ccfe1aabc010584c49b4277a88503216b78906ba719e30019c1.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="Lx">Lx</a>
  <ul class="header-links">
    
    
      <li>
        <a href="https://twitter.com/lxyuan" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/LxYuan0420" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/likxunyuan" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:lxyuan0420@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>AWS Endpoint: Multi-model vs Multi-container</h1>
            <p>This article briefly explains the difference between multi-model and multi-container AWS endpoint deployment</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    August 18, 2023
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      3 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>Amazon SageMaker is a managed machine learning service that provides a variety
of features for building, training, and deploying machine learning models. One
of these features is the ability to create endpoints, which are hosted
instances of machine learning models that can be used to make predictions.</p>

<p>When deploying a machine learning model to an endpoint, you have two options:
multi-model and multi-container.</p>

<p>Multi-model endpoints (MME) allow you to deploy multiple models in a single
container and share the same endpoint. This is useful if you have multiple
models that come from the same ML framework, the same algorithm, and perform
the same tasks (e.g., image classification). Referring to this
<a href="https://sagemaker-examples.readthedocs.io/en/latest/advanced_functionality/multi_model_xgboost_home_value/xgboost_multi_model_endpoint_home_value.html#Create-the-Amazon-SageMaker-MultiDataModel-entity">example</a>,
we just need to specify the S3 directory that contains all the models that
SageMaker multi-model endpoints will use to load and serve predictions. We can
see that the S3 prefix we specified when setting up MultiDataModel now has
multiple model artifacts. As such, the endpoint can now serve up inference
requests for these models. For instance:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nb">list</span><span class="p">(</span><span class="n">mme</span><span class="p">.</span><span class="n">list_models</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="s">'Chicago_IL.tar.gz'</span><span class="p">,</span>
<span class="s">'Houston_TX.tar.gz'</span><span class="p">,</span>
<span class="s">'LosAngeles_CA.tar.gz'</span><span class="p">,</span>
<span class="s">'NewYork_NY.tar.gz'</span>
<span class="p">]</span>

<span class="c1"># use target_model to specify model to call
</span><span class="n">predicted_value</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gen_random_house</span><span class="p">()[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">target_model</span><span class="o">=</span><span class="s">"Chicago_IL.tar.gz"</span><span class="p">)</span>

<span class="n">predicted_value</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gen_random_house</span><span class="p">()[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">target_model</span><span class="o">=</span><span class="s">"Houston_TX.tar.gz"</span><span class="p">)</span></code></pre></figure>

<p>However, it is worth mentioning that it is possible to deploy models from
different framework backends to SageMaker MME if they can use the same
container image, as demonstrated in this
<a href="https://github.com/aws/amazon-sagemaker-examples/blob/main/multi-model-endpoints/mme-on-gpu/cv/resnet50_mme_with_gpu.ipynb">example</a>.
Notice that they create one container and set <code class="highlighter-rouge">Mode</code> to <code class="highlighter-rouge">MultiModel</code>, and
similarly use <code class="highlighter-rouge">TargetModel</code> to specify which model to use.</p>

<p>Multi-container endpoints allow you to deploy multiple models in separate
containers and share the same endpoint. This is useful if you have multiple
models that are different from each other, such as a model for image
classification and a model for natural language processing. Another common use
case of this is to deploy multiple HF models into different containers, and
each of them uses different environment variables. For instance:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">textClassificationModel</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'Image'</span><span class="p">:</span> <span class="n">hf_inference_dlc</span><span class="p">,</span>
    <span class="s">'ContainerHostname'</span><span class="p">:</span> <span class="s">'textClassificationModel'</span><span class="p">,</span>
    <span class="s">'Environment'</span><span class="p">:</span> <span class="p">{</span>
	    <span class="s">'HF_MODEL_ID'</span><span class="p">:</span><span class="s">'SamLowe/roberta-base-go_emotions'</span><span class="p">,</span>
	    <span class="s">'HF_TASK'</span><span class="p">:</span><span class="s">'text-classification'</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">zeroShotModel</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'Image'</span><span class="p">:</span> <span class="n">hf_inference_dlc</span><span class="p">,</span>
    <span class="s">'ContainerHostname'</span><span class="p">:</span> <span class="s">'zeroShotModel'</span><span class="p">,</span>
    <span class="s">'Environment'</span><span class="p">:</span> <span class="p">{</span>
	    <span class="s">'HF_MODEL_ID'</span><span class="p">:</span><span class="s">'facebook/bart-large-mnli'</span><span class="p">,</span>
	    <span class="s">'HF_TASK'</span><span class="p">:</span><span class="s">'zero-shot-classification'</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Additional note on zipping model:</p>

<p>If you search online, you will find Python code that loads the model and
tokenizer from the Hugging Face model hub, and utilizes the tarfile Python
library. However, I would suggest handling the model cloning and zipping using
terminal commands to ensure the tar file is created correctly. Doing it with
Python code was nasty and wasted a few hours of my time.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git lfs <span class="nb">install</span>
<span class="nv">$ </span>git clone git@hf.co:lxyuan/distilgpt2-finetuned-finance <span class="c">#replace it with other models from hf hub</span>
<span class="nv">$ </span><span class="nb">cd </span>distilgpt2-finetuned-finance <span class="c"># make sure you cd into the dir</span>
<span class="nv">$ </span><span class="nb">tar </span>zcvf model.tar.gz <span class="k">*</span>
<span class="nv">$ </span>aws s3 <span class="nb">cp </span>model.tar.gz &lt;s3://<span class="o">{</span>my-s3-path<span class="o">}&gt;</span></code></pre></figure>

<p>Please read the docs mentioned below for better understanding:</p>

<p>Related:</p>
<ul>
  <li><a href="https://sagemaker-examples.readthedocs.io/en/latest/advanced_functionality/multi_model_xgboost_home_value/xgboost_multi_model_endpoint_home_value.html">Multi-model: Amazon SageMaker Multi-Model Endpoints using XGBoost</a></li>
  <li><a href="https://github.com/aws/amazon-sagemaker-examples/blob/main/multi-model-endpoints/mme-on-gpu/cv/resnet50_mme_with_gpu.ipynb">Multi-model: Run mulitple deep learning models on GPUs with Amazon SageMaker Multi-model endpoints (MME)</a></li>
  <li><a href="https://stackoverflow.com/questions/68913914/why-use-multi-container-endpoints-instead-of-multi-model-endpoints">Difference between Multi-model and multi-container</a></li>
  <li><a href="https://www.philschmid.de/sagemaker-huggingface-multi-container-endpoint">Multi-Container Endpoints with Hugging Face Transformers and Amazon SageMaker</a></li>
  <li><a href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md">Available images</a></li>
  <li><a href="https://huggingface.co/docs/sagemaker/reference#inference-dlc-overview">Hugginface DLC</a></li>
</ul>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=AWS+Endpoint:+Multi-model+vs+Multi-container%20-%20https://lxyuan0420.github.io/posts/aws-multimodel-multicontainer%20by%20@lxyuan" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://lxyuan0420.github.io/posts/aws-multimodel-multicontainer" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
        </article>
        <footer class="footer scrollappear">
  <p>
    Made with <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Download Chalk">Chalk</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  

<script src="/assets/vendor-3ee2c63bbac916f96cd7f90e83ab767f058ead1301444c9966f5156911c8be7f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
